import { StrokeData } from "@svgdotjs/svg.js";
import { GridPoints, IPolyPolygon } from "../grids";
import { RendererBase } from "../renderers/_base";
import { centroid } from "../common/plotting";

/**
 * This generator creates a moon squad board, which is a standard hexhex5 with the centre cell
 * split into three pentagonal cells, and edges hand adjusted to look more thematic.
 */
export const moon = (ctx: RendererBase): [GridPoints, IPolyPolygon[][]] => {
    if ( (ctx.json === undefined) || (ctx.rootSvg === undefined) ) {
        throw new Error("Object in an invalid state!");
    }

    // check required properties
    if (ctx.json.board === undefined || ctx.json.board === null) {
        throw new Error("The `board` property must exist.");
    }

    let baseStroke = 1;
    let baseColour = ctx.options.colourContext.strokes;
    let baseOpacity = 1;
    if ( ("strokeWeight" in ctx.json.board) && (ctx.json.board.strokeWeight !== undefined) ) {
        baseStroke = ctx.json.board.strokeWeight;
    }
    if ( ("strokeColour" in ctx.json.board) && (ctx.json.board.strokeColour !== undefined) ) {
        baseColour = ctx.resolveColour(ctx.json.board.strokeColour) as string;
    }
    if ( ("strokeOpacity" in ctx.json.board) && (ctx.json.board.strokeOpacity !== undefined) ) {
        baseOpacity = ctx.json.board.strokeOpacity;
    }
    const strokeAttrs: StrokeData = {color: baseColour, width: baseStroke, opacity: baseOpacity, linecap: "round", linejoin: "round"};

    // Get a grid of points
    const polys = JSON.parse(`[[{"type":"poly","points":[{"x":15.624301,"y":124.81673},{"x":38.410186,"y":121.46676},{"x":42.646494,"y":109.06019},{"x":31.450909,"y":98.376744}]},{"type":"poly","points":[{"x":31.450909,"y":98.376744},{"x":47.766827,"y":82.937336},{"x":57.458776,"y":95.080747},{"x":50.990505,"y":106.17199},{"x":42.646494,"y":109.06019}]},{"type":"poly","points":[{"x":47.766827,"y":82.937336},{"x":68.60188,"y":71.024069},{"x":79.629004,"y":84.518488},{"x":69.151504,"y":94.995988},{"x":57.458776,"y":95.080748}]},{"type":"poly","points":[{"x":68.60188,"y":71.024069},{"x":89.383332,"y":64.931345},{"x":99.555121,"y":81.544125},{"x":89.850176,"y":86.662653},{"x":79.629004,"y":84.518488}]},{"type":"poly","points":[{"x":89.383332,"y":64.931345},{"x":124.13154,"y":65.094429},{"x":116.71011,"y":81.724488},{"x":99.555121,"y":81.544125}]}],[{"type":"poly","points":[{"x":8.7685196,"y":151.52979},{"x":15.624301,"y":124.81673},{"x":38.410186,"y":121.46676},{"x":34.01337,"y":134.34341},{"x":23.992564,"y":149.96538}]},{"type":"poly","points":[{"x":34.01337,"y":134.34341},{"x":47.227209,"y":134.35831},{"x":61.51165,"y":123.08672},{"x":50.990505,"y":106.17199},{"x":42.646494,"y":109.06019},{"x":38.410186,"y":121.46676}]},{"type":"poly","points":[{"x":61.51165,"y":123.08672},{"x":68.011642,"y":117.84773},{"x":76.214932,"y":106.19769},{"x":69.151504,"y":94.995988},{"x":57.458776,"y":95.080748},{"x":50.990505,"y":106.17199}]},{"type":"poly","points":[{"x":76.214932,"y":106.19769},{"x":88.690952,"y":106.19769},{"x":103.6471,"y":101.68964},{"x":89.850176,"y":86.662653},{"x":79.629004,"y":84.518488},{"x":69.151504,"y":94.995988}]},{"type":"poly","points":[{"x":89.850176,"y":86.662653},{"x":99.555121,"y":81.544125},{"x":116.71011,"y":81.724486},{"x":124.20161,"y":88.172768},{"x":119.3198,"y":101.4959},{"x":103.6471,"y":101.68964}]},{"type":"poly","points":[{"x":124.20161,"y":88.172768},{"x":139.23869,"y":89.40334},{"x":143.8256,"y":70.946858},{"x":124.13154,"y":65.094429},{"x":116.71011,"y":81.724486}]}],[{"type":"poly","points":[{"x":8.7685194,"y":151.52979},{"x":9.2129252,"y":172.847},{"x":27.4486,"y":171.54207},{"x":29.802129,"y":159.95649},{"x":23.992564,"y":149.96538}]},{"type":"poly","points":[{"x":29.802129,"y":159.95649},{"x":23.992564,"y":149.96538},{"x":34.01337,"y":134.34341},{"x":47.227209,"y":134.35831},{"x":48.398898,"y":148.6684},{"x":49.203429,"y":160.65339}]},{"type":"poly","points":[{"x":48.398898,"y":148.66837},{"x":65.335797,"y":148.10422},{"x":71.417835,"y":133.82601},{"x":67.962372,"y":117.9177},{"x":61.51165,"y":123.08672},{"x":47.227209,"y":134.35828}]},{"type":"poly","points":[{"x":71.417835,"y":133.82601},{"x":98.802803,"y":121.77645},{"x":88.690952,"y":106.19769},{"x":76.214932,"y":106.19769},{"x":68.011642,"y":117.84773}]},{"type":"poly","points":[{"x":98.802803,"y":121.77645},{"x":116.28968,"y":119.1526},{"x":125.65464,"y":111.48573},{"x":119.3198,"y":101.4959},{"x":103.6471,"y":101.68964},{"x":88.690952,"y":106.19769}]},{"type":"poly","points":[{"x":125.65464,"y":111.48573},{"x":135.07353,"y":111.48572},{"x":145.07337,"y":95.694488},{"x":139.23869,"y":89.40334},{"x":124.20161,"y":88.172768},{"x":119.3198,"y":101.4959}]},{"type":"poly","points":[{"x":145.07337,"y":95.694486},{"x":154.14033,"y":97.241208},{"x":166.4342,"y":84.274863},{"x":143.8256,"y":70.946858},{"x":139.23869,"y":89.40334}]}],[{"type":"poly","points":[{"x":9.2129252,"y":172.847},{"x":14.367271,"y":194.07334},{"x":33.23726,"y":195.28925},{"x":36.905932,"y":183.85354},{"x":27.4486,"y":171.54207}]},{"type":"poly","points":[{"x":36.905932,"y":183.85354},{"x":52.245318,"y":182.8242},{"x":55.971093,"y":172.3753},{"x":49.203429,"y":160.65339},{"x":29.802129,"y":159.95649},{"x":27.4486,"y":171.54207}]},{"type":"poly","points":[{"x":55.971093,"y":172.3753},{"x":70.805724,"y":175.08405},{"x":71.836303,"y":163.96981},{"x":65.335797,"y":148.10422},{"x":48.398898,"y":148.66837},{"x":49.203429,"y":160.65339}]},{"type":"poly","points":[{"x":71.836303,"y":163.96981},{"x":65.335797,"y":148.10422},{"x":71.417835,"y":133.82601},{"x":83.735533,"y":128.51935},{"x":90.917508,"y":139.28814},{"x":81.779731,"y":158.67573}]},{"type":"poly","points":[{"x":83.735533,"y":128.51935},{"x":98.802803,"y":121.77645},{"x":116.28968,"y":119.1526},{"x":118.36561,"y":129.35739},{"x":120.19405,"y":140.17122},{"x":100.99617,"y":139.7009},{"x":90.917513,"y":139.28814}]},{"type":"poly","points":[{"x":116.28968,"y":119.1526},{"x":125.65464,"y":111.48573},{"x":135.07353,"y":111.48572},{"x":144.07807,"y":120.48948},{"x":135.65794,"y":132.76887},{"x":118.36561,"y":129.35734}]},{"type":"poly","points":[{"x":135.07354,"y":111.48572},{"x":145.07337,"y":95.694488},{"x":154.14033,"y":97.241208},{"x":158.55142,"y":111.48571},{"x":157.62563,"y":126.68267},{"x":144.07807,"y":120.48948}]},{"type":"poly","points":[{"x":154.14033,"y":97.241208},{"x":166.4342,"y":84.274863},{"x":182.40432,"y":99.889338},{"x":168.1971,"y":119.10281},{"x":158.55142,"y":111.48571}]}],[{"type":"poly","points":[{"x":14.367271,"y":194.07334},{"x":30.959033,"y":223.31375},{"x":42.014957,"y":206.65103},{"x":33.23726,"y":195.28925}]},{"type":"poly","points":[{"x":42.014957,"y":206.65103},{"x":50.567028,"y":212.45495},{"x":53.359568,"y":197.19243},{"x":52.245318,"y":182.8242},{"x":36.905932,"y":183.85354},{"x":33.23726,"y":195.28925}]},{"type":"poly","points":[{"x":53.359568,"y":197.19243},{"x":71.201528,"y":198.75519},{"x":80.327504,"y":183.00699},{"x":70.805724,"y":175.08405},{"x":55.971093,"y":172.3753},{"x":52.245318,"y":182.8242}]},{"type":"poly","points":[{"x":80.327504,"y":183.00699},{"x":90.146279,"y":190.96598},{"x":95.006206,"y":183.3517},{"x":91.684413,"y":162.90338},{"x":81.779731,"y":158.67573},{"x":71.836303,"y":163.96981},{"x":70.805724,"y":175.08405}]},{"type":"poly","points":[{"x":81.779731,"y":158.67573},{"x":90.917513,"y":139.28814},{"x":100.99617,"y":139.7009},{"x":106.45952,"y":163.17073},{"x":91.684413,"y":162.90338}]},{"type":"poly","points":[{"x":106.45952,"y":163.17073},{"x":116.91059,"y":169.86103},{"x":126.5421,"y":163.64958},{"x":120.19405,"y":140.17122},{"x":100.99617,"y":139.7009}]},{"type":"poly","points":[{"x":112.02039,"y":184.2411},{"x":116.91059,"y":169.86103},{"x":106.45952,"y":163.17073},{"x":91.684413,"y":162.90338},{"x":95.006206,"y":183.3517}]},{"type":"poly","points":[{"x":126.5421,"y":163.64958},{"x":137.40474,"y":157.96932},{"x":141.55949,"y":145.00448},{"x":135.65794,"y":132.76892},{"x":118.36561,"y":129.35739},{"x":120.19405,"y":140.17122}]},{"type":"poly","points":[{"x":141.55949,"y":145.00443},{"x":155.90868,"y":154.86679},{"x":156.82262,"y":139.86435},{"x":157.62563,"y":126.68267},{"x":144.07807,"y":120.48948},{"x":135.65794,"y":132.76887}]},{"type":"poly","points":[{"x":156.82262,"y":139.86435},{"x":182.22693,"y":142.05239},{"x":182.28103,"y":130.22475},{"x":168.1971,"y":119.10281},{"x":158.55142,"y":111.48571},{"x":157.62563,"y":126.68267}]},{"type":"poly","points":[{"x":182.28103,"y":130.22475},{"x":196.8353,"y":124.43716},{"x":182.40432,"y":99.889338},{"x":168.1971,"y":119.10281}]}],[{"type":"poly","points":[{"x":30.959033,"y":223.31375},{"x":48.895005,"y":240.17645},{"x":57.195362,"y":219.62351},{"x":50.567028,"y":212.45495},{"x":42.014957,"y":206.65103}]},{"type":"poly","points":[{"x":57.195362,"y":219.62351},{"x":68.164452,"y":225.99367},{"x":77.83732,"y":210.24872},{"x":71.201528,"y":198.75519},{"x":53.359568,"y":197.19243},{"x":50.567028,"y":212.45495}]},{"type":"poly","points":[{"x":77.83732,"y":210.24872},{"x":91.810212,"y":212.44948},{"x":95.606829,"y":202.58094},{"x":90.146279,"y":190.96598},{"x":80.327504,"y":183.00699},{"x":71.201528,"y":198.75519}]},{"type":"poly","points":[{"x":95.606829,"y":202.58094},{"x":116.54187,"y":201.96992},{"x":121.73088,"y":185.02558},{"x":112.02039,"y":184.2411},{"x":95.006206,"y":183.3517},{"x":90.146279,"y":190.96598}]},{"type":"poly","points":[{"x":121.73088,"y":185.02558},{"x":136.77313,"y":185.12791},{"x":142.67828,"y":174.7804},{"x":137.40474,"y":157.96937},{"x":126.5421,"y":163.64958},{"x":116.91059,"y":169.86103},{"x":112.02039,"y":184.2411}]},{"type":"poly","points":[{"x":142.67828,"y":174.7804},{"x":154.30619,"y":174.765},{"x":163.1434,"y":161.05318},{"x":155.90868,"y":154.86679},{"x":141.55949,"y":145.00448},{"x":137.40474,"y":157.96932}]},{"type":"poly","points":[{"x":163.1434,"y":161.05318},{"x":183.26085,"y":161.42594},{"x":185.26785,"y":151.95361},{"x":182.22693,"y":142.05239},{"x":156.82262,"y":139.86435},{"x":155.90868,"y":154.86679}]},{"type":"poly","points":[{"x":185.26785,"y":151.95362},{"x":203.27286,"y":149.30238},{"x":196.8353,"y":124.43716},{"x":182.28103,"y":130.22475},{"x":182.22693,"y":142.05239}]}],[{"type":"poly","points":[{"x":48.895005,"y":240.17645},{"x":68.99126,"y":251.4197},{"x":76.136504,"y":234.69599},{"x":68.16445,"y":225.99367},{"x":57.195362,"y":219.62351}]},{"type":"poly","points":[{"x":76.136504,"y":234.69599},{"x":88.176393,"y":234.94714},{"x":97.736296,"y":218.8804},{"x":91.810212,"y":212.44948},{"x":77.83732,"y":210.24872},{"x":68.16445,"y":225.99367}]},{"type":"poly","points":[{"x":97.736296,"y":218.8804},{"x":112.86626,"y":222.41373},{"x":118.40613,"y":211.14806},{"x":116.54187,"y":201.96992},{"x":95.606829,"y":202.58094},{"x":91.810212,"y":212.44948}]},{"type":"poly","points":[{"x":118.40613,"y":211.14806},{"x":132.42426,"y":210.65625},{"x":136.4352,"y":199.65854},{"x":136.77313,"y":185.12791},{"x":121.73088,"y":185.02558},{"x":116.54187,"y":201.96992}]},{"type":"poly","points":[{"x":136.4352,"y":199.65854},{"x":153.02162,"y":198.69524},{"x":161.37279,"y":182.85356},{"x":154.30619,"y":174.765},{"x":142.67828,"y":174.7804},{"x":136.77313,"y":185.12791}]},{"type":"poly","points":[{"x":161.37279,"y":182.85356},{"x":180.41237,"y":182.81886},{"x":182.08531,"y":172.18434},{"x":183.26085,"y":161.42594},{"x":163.1434,"y":161.05318},{"x":154.30619,"y":174.765}]},{"type":"poly","points":[{"x":182.08531,"y":172.18434},{"x":203.37925,"y":172.10694},{"x":203.27286,"y":149.30238},{"x":185.26785,"y":151.95362},{"x":183.26085,"y":161.42594}]}],[{"type":"poly","points":[{"x":68.99126,"y":251.4197},{"x":89.209191,"y":257.3197},{"x":98.488504,"y":241.68099},{"x":88.176393,"y":234.94714},{"x":76.136504,"y":234.69599}]},{"type":"poly","points":[{"x":98.488504,"y":241.68099},{"x":112.45851,"y":238.88699},{"x":122.63023,"y":236.01709},{"x":112.86626,"y":222.41373},{"x":97.736296,"y":218.8804},{"x":88.176393,"y":234.94714}]},{"type":"poly","points":[{"x":122.63023,"y":236.01709},{"x":139.15285,"y":234.28408},{"x":139.03806,"y":224.69224},{"x":132.42426,"y":210.65625},{"x":118.40613,"y":211.14806},{"x":112.86626,"y":222.41373}]},{"type":"poly","points":[{"x":139.03806,"y":224.69224},{"x":154.45941,"y":223.5963},{"x":160.90291,"y":210.59984},{"x":153.02162,"y":198.69524},{"x":136.4352,"y":199.65854},{"x":132.42426,"y":210.65625}]},{"type":"poly","points":[{"x":160.90291,"y":210.59984},{"x":170.22808,"y":209.64089},{"x":178.71338,"y":193.61896},{"x":180.41237,"y":182.81886},{"x":161.37279,"y":182.85356},{"x":153.02162,"y":198.69524}]},{"type":"poly","points":[{"x":178.71338,"y":193.61896},{"x":197.54027,"y":194.88807},{"x":203.37925,"y":172.10694},{"x":182.08531,"y":172.18434},{"x":180.41237,"y":182.81886}]}],[{"type":"poly","points":[{"x":89.209191,"y":257.3197},{"x":119.69001,"y":257.90455},{"x":112.45851,"y":238.88699},{"x":98.488504,"y":241.68099}]},{"type":"poly","points":[{"x":119.69001,"y":257.90455},{"x":140.81373,"y":252.52783},{"x":139.15285,"y":234.28408},{"x":122.63023,"y":236.01709},{"x":112.45851,"y":238.88699}]},{"type":"poly","points":[{"x":140.81373,"y":252.52783},{"x":164.30391,"y":239.21633},{"x":154.45941,"y":223.5963},{"x":139.03806,"y":224.69224},{"x":139.15285,"y":234.28408}]},{"type":"poly","points":[{"x":164.30391,"y":239.21633},{"x":179.87146,"y":224.42787},{"x":170.22808,"y":209.64089},{"x":160.90291,"y":210.59984},{"x":154.45941,"y":223.5963}]},{"type":"poly","points":[{"x":179.87146,"y":224.42787},{"x":197.54027,"y":194.88807},{"x":178.71338,"y":193.61896},{"x":170.22808,"y":209.64089}]}]]`) as IPolyPolygon[][];
    const grid: GridPoints = polys.map(row => row.map(cell => centroid(cell.points)!));
    const board = ctx.rootSvg.group().id("board");
    const gridlines = board.group().id("gridlines");

    ctx.markBoard({svgGroup: gridlines, preGridLines: true, grid, polys});

    // Add board labels
    // This board is unlabelled

    // Draw grid lines
    for (let y = 0; y < polys.length; y++) {
        const row = polys[y];
        for (let x = 0; x < row.length; x++) {
            const cell = row[x];
            const ele = gridlines.polygon(cell.points.map(pt => `${pt.x},${pt.y}`).join(" ")).fill({color: "white", opacity: 0}).stroke(strokeAttrs);
            if (ctx.options.boardClick !== undefined) {
                ele.click(() => ctx.options.boardClick!(y, x, ""));
            }
        }
    }

    ctx.markBoard({svgGroup: gridlines, preGridLines: false, grid, polys});

    return [grid, polys];
}
